### [DEP #30][]: Non-null Types and Non-null By Default (NNBD)

This is an **EXPERIMENTAL** version of the [Dart Analyzer](https://github.com/dart-lang/sdk/tree/master/pkg/analyzer) providing an implementation of [DEP #30][].

For details see the DEP #30, [Appendix II][]: *Tooling and preliminary experience report*.

-----

#### Feature status

The variant of the proposal described in [II.1](#proposal-variant) has been implemented:

- [A.2][]. Drop semantic rules giving special treatment to `null`.
- [B.2][]. Ensure `Object` is non-null by making `Null` a root ([B.4.7](https://github.com/chalin/DEP-non-null/blob/master/doc/dep-non-null-AUTOGENERATED-DO-NOT-EDIT.md#object-not-nullable-alt)).
- [B.2][]. Support meta type annotations
    - `@nullable` and `@non_null` ([B.4.6](https://github.com/chalin/DEP-non-null/blob/master/doc/dep-non-null-AUTOGENERATED-DO-NOT-EDIT.md#type-anno-alt)), and in those places where [DartC][] does not currently support metadata, 
    - allow the use of specialized comments `/*?*/` and `/*!*/`.
- [C.3][]. Support for generics matches the proposal.
- [G.2][]. Support `library`, `part` and `class` level `@nullable_by_default` annotations.

Except for the following features which are planned, but not yet supported:

- [ ] [B.2.5](https://github.com/chalin/DEP-non-null/blob/master/doc/dep-non-null-AUTOGENERATED-DO-NOT-EDIT.md#factory-constructors). Syntax for nullable factory constructors.
- [ ] [B.3.8](https://github.com/chalin/DEP-non-null/blob/master/doc/dep-non-null-AUTOGENERATED-DO-NOT-EDIT.md#lub). Type least upper bound.
- [ ] `!dynamic`, [D.2.1](https://github.com/chalin/DEP-non-null/blob/master/doc/dep-non-null-AUTOGENERATED-DO-NOT-EDIT.md#dynamic-and-type-operators) and [D.2.2](https://github.com/chalin/DEP-non-null/blob/master/doc/dep-non-null-AUTOGENERATED-DO-NOT-EDIT.md#bang-dynamic-subtype-of). (partially supported)
- [ ] [E.3.6](https://github.com/chalin/DEP-non-null/blob/master/doc/dep-non-null-AUTOGENERATED-DO-NOT-EDIT.md#local-var-analysis). Reducing the annotation burden for local variables.

Also see the [open issues](https://github.com/chalin/sdk/issues).

#### Annotating your code

Make use of `@nullable` and `@non_null` annotations where supported by Dart, otherwise you can fall back on use of `/*?*/` and `/*!*/` comment markers. This is a _prototype_ with _experimental input syntax_ so there are some important **CAVEATS**:

- Internally the analyzer discards adjacent comments under some circumstances: e.g. 

    ```dart
    // a comment preceding the ? marker below
    /*?*/ String m() { ... } // <======= `?` IGNORED!
    ```

    will cause `/*?*/` to be ignored. Hence the recommendation to use annotations whenever possible. The situation above is easily avoided by writing:

    ```dart
    // a comment preceding the ? marker below
    @nullable String m() { ... } // OK
    ```

- There is currently **no checking of the validity of annotations** (e.g., duplicate or misplaced annotations).

#### Running the experimental Analyzer

**Setup**: download this [Dart SDK fork (dep30 branch)][chalin/sdk] as well as the adapted [analyzer_cli fork (dep30 branch)][chalin/analyzer_cli]. These instructions assume that you have the following environment variables defined and projects checked out:

- `export DART_SDK=`*path-to-your-dart-sdk*; e.g. `/opt/homebrew/opt/dart/libexec`.
- `$HOME/git/sdk`, a checkout of [dart-lang/sdk](https://github.com/dart-lang/sdk).
- `$HOME/git/analyzer_cli`, a checkout of [analyzer_cli fork (dep30 branch)][chalin/analyzer_cli].
- `$HOME/git/dep30/sdk`, a checkout of [this SDK fork][chalin/sdk].

You will need to build the `dep30/sdk`. See the [Dart SDK "Preparing your machine"](https://github.com/dart-lang/sdk/wiki/Preparing-your-machine-to-build-the-Dart-SDK) and [Build and Test](https://github.com/dart-lang/sdk/wiki/Building) instructions for how to setup your environment. Then run, e.g.,:

```shell
> ./tools/build.py -a x64 create_sdk
...
> export DART_SDK_NNBD=$HOME/git/dep30/sdk/xcodebuild/DebugX64/dart-sdk
```

**Running the analyzer**

Run the analyzer from the command line using the analyzer_cli with the `--enable-non-null` option _and_ by setting the environment variable `DEP_NNBD` to 1 (this latter requirement will be lifted at some point). Leaving `DEP_NNBD` undefined causes [DEP #30][] code changes to be eliminated (at compile time) and hence the analyzer behaves as it would in [DartC][]. E.g.,

```shell
> $DART_SDK_NNBD/bin/dart -c -DDEP_NNBD=1 -c \
  $HOME/git/analyzer_cli/bin/analyzer.dart --enable-non-null \
    --dart-sdk $DART_SDK_NNBD
```

Other useful analyzer_cli options are:

- `--warnings` to also issue warnings over the SDK itself.
- `--no-hints`

#### Running Analyzer tests

This should only be necessary if you are making changes to the code base or if you want a sanity check of your setup. See the top of the [Makefile](Makefile) for variables you need to define and targets you can use. E.g., to run all tests:

```shell
make ORIG_SDK_PROJ=$HOME/git/sdk
```

The default target runs:

- `test`: DEP30 specific tests with and without `--enable-non-null`, as well as
- `comp`: the full suite of Analyzer tests with and without `--enable-non-null` and then compares results.

If all goes well, output should look something like this (number of tests may vary and diff might not report any differences):

```shell
Testing from /Users/chalin/git/dep30/analyzer
NNBD
All 228 tests passed.
NuBD
All 228 tests passed.
Testing from /Users/chalin/git/dep30/analyzer
All 7127 tests passed.

diff ~/tmp/test_all_dartc_summary.txt ~/tmp/test_all_nubd_summary.txt
1c1
< All 7128 tests passed.
---
> All 7127 tests passed.
```

[chalin/analyzer_cli]: https://github.com/chalin/analyzer_cli/tree/dep30
[chalin/sdk]: https://github.com/chalin/sdk/tree/dep30
[DEP #30]: https://github.com/dart-lang/dart_enhancement_proposals/issues/30
[proposal]: https://github.com/chalin/DEP-non-null/blob/master/doc/dep-non-null-AUTOGENERATED-DO-NOT-EDIT.md
[proposal PDF]:https://github.com/chalin/DEP-non-null/raw/master/doc/dep-non-null.pdf
[Appendix II]: https://github.com/chalin/DEP-non-null/blob/master/doc/dep-non-null-AUTOGENERATED-DO-NOT-EDIT.md#appendix-tooling
[DartC]: https://github.com/chalin/DEP-non-null/blob/master/doc/dep-non-null-AUTOGENERATED-DO-NOT-EDIT.md#terms "Classic (i.e., current) Dart"
[II.1]: https://github.com/chalin/DEP-non-null/blob/master/doc/dep-non-null-AUTOGENERATED-DO-NOT-EDIT.md#proposal-variant
[A.2]: https://github.com/chalin/DEP-non-null/blob/master/doc/dep-non-null-AUTOGENERATED-DO-NOT-EDIT.md#non-null-types
[B.2]: https://github.com/chalin/DEP-non-null/blob/master/doc/dep-non-null-AUTOGENERATED-DO-NOT-EDIT.md#nnbd
[C.3]: https://github.com/chalin/DEP-non-null/blob/master/doc/dep-non-null-AUTOGENERATED-DO-NOT-EDIT.md#generics
[G.2]: https://github.com/chalin/DEP-non-null/blob/master/doc/dep-non-null-AUTOGENERATED-DO-NOT-EDIT.md#g-2-migration-aids

-----

The analysis package defines support for performing static analysis of Dart
code. It was designed to support tooling efforts, but has also been used for
such things as statistics gathering and code transformers.

If you are interested in providing Dart support in a long-running tool, such as
an editor or IDE, you should use the analysis server instead of this package.
The analysis server is currently shipped as an executable in the SDK and will
be released as a package in the near future. In the meantime, if you'd like to
learn more about it, please look at the
[Analysis Server API Specification](http://htmlpreview.github.io/?https://github.com/dart-lang/bleeding_edge/blob/master/dart/pkg/analysis_server/doc/api.html)
or contact the mailing list (see below).

The API's in this package are, quite frankly, a mess at the moment. They were
originally machine generated by a translator and were based on an earlier Java
implementation. Several of the API's still look like their Java predecessors
(or worse) rather than clean Dart API's.

In addition, there is currently no clean distinction between public and internal
API's. We plan to address this issue soon, but doing so will, unfortunately,
require a large number of breaking changes. We will try to minimize the pain
this causes for our clients, but some pain is inevitable.

Questions and requests for additional functionality are welcome, and can be made
by either opening an issue at
[http://dartbug.com](http://dartbug.com)
or by emailing
[analyzer-discuss@dartlang.org](https://groups.google.com/a/dartlang.org/forum/#!forum/analyzer-discuss).
